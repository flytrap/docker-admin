version: '3.8'

services:
  # Tailscale 容器：负责接入私有网格
  tailscale:
    image: tailscale/tailscale:v1.92.5
    container_name: tailscaled
    hostname: teleport
    env_file: .env
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY} # 在 Tailscale 控制台生成的 Auth Key
      - TS_STATE_DIR=/var/lib/tailscale
    volumes:
      - ./tailscale_data:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun # 必须挂载 tun 设备
    ports:
      - "80:80"
      - "443:443"
      - "3025:3025"  # Auth Service
      - "3080:3080"  # Web UI
      - "3022:3022"  # SSH Proxy (建议也加上，方便后续添加节点)
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: always

  # Teleport 容器：堡垒机服务
  teleport:
    image: public.ecr.aws/gravitational/teleport-distroless:17.6.0 # 使用最新的稳定版
    container_name: teleport
    restart: unless-stopped
    network_mode: "service:tailscale" # 关键：共享 Tailscale 的网络栈
    volumes:
      - ./teleport_config:/etc/teleport
      - ./teleport_config/rootCA.pem:/etc/ssl/certs/ca-certificates.crt:ro
      - ./teleport_data:/var/lib/teleport
    entrypoint: /usr/local/bin/teleport start -c /etc/teleport/teleport.yaml
    depends_on:
      - tailscale

